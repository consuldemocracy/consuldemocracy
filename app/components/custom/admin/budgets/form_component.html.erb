<%= translatable_form_for [namespace, budget], html: { class: "budgets-form" } do |f| %>
  <%= render Admin::BudgetsWizard::ModelFieldComponent.new %>

  <fieldset>
    <legend><%= t("admin.budgets.edit.info.budget_settings") %></legend>
    <%= render "shared/globalize_locales", resource: budget %>
    <%= render "shared/errors", resource: budget %>

    <%= f.translatable_fields do |translations_form| %>
      <div class="row expanded">
        <div class="small-12 medium-9 large-6 column end">
          <%= translations_form.text_field :name,
                                            maxlength: Budget.title_max_length,
                                            hint: t("admin.budgets.edit.name_description") %>
        </div>
      </div>
      <div class="row expanded">
        <div class="small-12 medium-9 large-6 column end">
          <p class="form-label"><%= t("admin.budgets.edit.main_call_to_action") %></p>
          <p class="help-text"> <%= t("admin.budgets.edit.main_call_to_action_description") %></p>
          <%= translations_form.text_field :main_link_text %>
        </div>
      </div>
        <div class="small-12 column">
          <button class="button add_field_button" id=<%= translations_form.locale %>>Add More Fields</button>
        </div>
          <div class="input_fields_wrap" id=<%= translations_form.locale %>>
            <% budget.questions.each_with_index do |key, index|%>
            <div class="small-12 column">
              <div class="small-12 medium-9 large-6 column end">
                  <%= translations_form.text_field :questions, label: "Question", value: key,  multiple: true, class: "form-control" %>
                  <a href="#" class="delete remove_field">Remove question</a>
              </div>
            </div>
            <% end %>
      </div>
      <script>
      // this script is render 3 times because its inside f.translatable_fields do |translations_form|
      // It needs to be inside loop so we can dynamicly add translations_form.texfield
      // So every button click gets rendered 3 times
      // e.target.id takes care that it renders only in correct wrapper
      // and numberOfReRenders % numberOfLanguages === 1 takes care that it only renders once. 
      var isClicked = true
      var numberOfReRenders = 0
      var numberOfLanguages = 0
      $(document).ready(function() {
        var max_fields      = 10; //maximum input boxes allowed
        var wrapper   		= $(".input_fields_wrap"); //Fields wrapper
        var add_button      = $(".add_field_button"); //Add button ID
        numberOfLanguages++
        var x = 1; //initlal text box count
        $(add_button).click(function(e){ //on add input button click
        button = $("#"+e.target.id+".add_field_button");
          numberOfReRenders+++
          e.preventDefault();
          if(numberOfReRenders % numberOfLanguages === 1 || numberOfLanguages === 1){ //max input box allowed
            x++;
            wrapper = $("#"+e.target.id+".input_fields_wrap");
            // TODO break it into multiple lines
            $(wrapper).append('<div class="small-12 column"><div class="small-12 medium-9 large-6 column end"><%= translations_form.text_field :questions, label: "Question:", multiple: true, class: "form-control", value: ""%><a href="#" class="delete remove_field">Remove question</a></div></div>'); //add input box
          }
        });
        $(wrapper).on("click",".remove_field", function(e){ //user click on remove text
          e.preventDefault(); $(this).parent('div').remove(); x--;
        })
      });
    </script>
    <% end %>

    <div class="row expanded">
      <div class="small-12 medium-9 large-6 column end">
        <%= f.text_field :main_link_url, placeholder: t("admin.shared.example_url") %>
      </div>
    </div>

    <div class="row expanded">
      <div class="small-12 medium-4 column">
        <%= f.select :voting_style, voting_styles_select_options %>
      </div>

      <div class="small-12 medium-2 column end">
        <%= f.select :currency_symbol, currency_symbol_select_options %>
      </div>
    </div>

    <% if feature?(:allow_images) %>
      <div class="images small-12 column">
        <%= render "/images/nested_image", f: f %>
        <p class="help-text"><%= t("admin.budgets.edit.image_description") %></p>
      </div>
    <% end %>
  </fieldset>

  <fieldset>
    <legend><%= t("admin.budgets.edit.info.staff_settings") %></legend>

    <% %w[administrators valuators].each do |staff| %>
      <div class="small-12 medium-6 large-3 column end">
        <%= link_to t("admin.budgets.edit.#{staff}", count: budget.send(staff).count),
          "#",
          class: "button expanded hollow js-budget-show-#{staff}-list js-budget-show-users-list",
          data: { toggle: "#{staff}_list", texts: t("admin.budgets.edit.#{staff}") } %>
      </div>
    <% end %>

    <%= render "/admin/budgets/association", assignable_type: "administrators", assignables: admins, form: f %>
    <%= render "/admin/budgets/association", assignable_type: "valuators", assignables: valuators, form: f %>
  </fieldset>

  <% unless wizard? %>
    <fieldset>
      <legend><%= t("admin.budgets.edit.info.phases_settings") %></legend>
      <div class="small-12 medium-6 column">
        <%= f.select :phase, phases_select_options %>
      </div>

      <%= render Admin::BudgetPhases::PhasesComponent.new(budget) %>
    </fieldset>

    <%= render "admin/shared/show_results_fields", form: f %>
  <% end %>

  <div class="small-12 column">
    <div class="clear small-12 medium-4 large-3 inline-block">
      <% if wizard? %>
        <%= f.submit t("admin.budgets_wizard.budgets.continue"), class: "button success expanded" %>
      <% else %>
        <%= f.submit nil, class: "button success" %>
      <% end %>
    </div>

    <div class="float-right">
      <% if display_calculate_winners_button?(budget) %>
        <%= link_to calculate_winner_button_text(budget),
                    calculate_winners_admin_budget_path(budget),
                    method: :put,
                    class: "button hollow" %>
      <% end %>

      <% if budget.has_winning_investments? %>
        <%= link_to t("budgets.show.see_results"),
                    budget_results_path(budget),
                    class: "button hollow margin-left" %>
      <% end %>
      <% if budget.persisted? %>
        <%= link_to t("admin.budgets.edit.delete"),
            admin_budget_path(budget),
            method: :delete,
            class: "delete float-right margin-left" %>
      <% end %>
    </div>
  </div>
<% end %>
